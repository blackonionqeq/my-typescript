# 至最新版本为止的总结

## 21-11-12
极简版成形。
只包含识别函数声明和函数调用的功能，不过麻雀虽小五脏俱全，跟大而全的编译器一样，整体可分为几个部分：词法分析器、语法分析器、语义分析器和执行器。

词法分析器是把代码（字符流）加工为一个有意义的最小单位（token）的流，以便后面以最小单位为单位对代码进行处理。实现的要点，是要十分小心什么时候peek，什么时候next（区别是是否消化掉当前字符）。有个优化的手段，是预读后缩小可能字符结果的集合来减少回溯。

语法分析器把token流加工为一棵树，以便后面对树进行遍历以实现执行的效果。实现的要点，和词法分析一样小心什么时候peek什么时候next（不一样的是词法分析吐掉的是token而非字符），可以注释每个分析函数的EBNF或正则匹配来理清逻辑。有个优化的手段，是预读后缩小可能token结果的集合来减少回溯。

语义分析器是对树进行加工，以省去运行时需要进行的一些操作，例如找到函数调用对应的函数等。实现需要遍历树的方法，并在合适的时机进行需要的转化或求值。

执行器遍历语法树，执行相应逻辑。和语义分析类似，遍历树时在合适的时机进行合适的求值等操作。

## 21-11-15
with-digital-version成形，正如其名，支持了数字类型，以及变量。
形式改变：总的来说词法分析语法分析语义分析因功能而膨胀，所以每个步骤改为单独一个文件了。

基类变动：AST节点增加accept方法和增加访问者类，用于遍历ast时访问者得以访问节点内容，且让遍历操作和ast节点解耦。ast节点下设statement和expression，区别是statement没有返回值，expression有返回值。statement下有声明，包括变量声明和函数声明，和表达式语句。expression下有各种字面量，以及二元表达式。

词法分析：增加了关键词，识别为identifier后会进行关键词匹配，把token类型变为关键词。另外语法分析过程有用到L2匹配，所以增加了超前匹配的方法。

语法分析：这次变更的大头。重点是增加了表达式，其中的难点是二元表达式的处理，二元表达式引入了运算符优先机的概念，可以选择递归式或者单调栈的迭代式操作。总的思路跟以前一样，通过列出L1甚至L2，来更精确匹配以最大程度地减少回溯。

语义分析：新增词汇表，保存声明的变量和函数。然后在调用变量或函数时解引用。

执行器：在条件适合时覆盖父级方法。具体来说是遇到函数声明改为啥也不做，遇到函数调用改为获取变量后调用，遇到变量声明保存起来，遇到变量调用时改为返回一个包裹着变量的左值，以便获取或改变值。